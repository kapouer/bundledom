#!/usr/bin/node

var Path = require('path');
var dash = require('dashdash');

process.chdir(Path.dirname(__dirname));

var parser = dash.createParser({options: [
	{
		names: ['help', 'h'],
		type: 'bool',
		help: 'Print this help and exit.'
	},
	{
		names: ['serialize'],
		type: 'string',
		help: 'serialize modified DOM to file'
	},
	{
		names: ['prepend'],
		type: 'arrayOfString',
		help: 'prepend scripts'
	},
	{
		names: ['append'],
		type: 'arrayOfString',
		help: 'append scripts'
	},
	{
		names: ['exclude'],
		type: 'arrayOfString',
		help: 'exclude scripts, links, imports'
	},
	{
		names: ['output'],
		type: 'string',
		help: 'bundle output file name'
	},
	{
		names: ['concatenate'],
		type: 'bool',
		help: 'do not minify'
	}
]});

var opts;
try {
	opts = parser.parse(process.argv);
} catch(e) {
	console.error(e.toString());
	opts = {help: true};
}

var htmlPath = opts._args && opts._args.pop();

if (opts.help || !htmlPath || !require('fs').existsSync(htmlPath)) {
	var help = parser.help({includeEnv: true}).trimRight();
	console.log(`usage: bundledom [opts] <html file path>\n${help}`);
	process.exit(0);
}

var bundledom = require('..');

opts.cli = true;

bundledom(htmlPath, opts).then(function(str) {
	if (!opts.output) console.log(str);
}).catch(function(err) {
	console.error(err);
	process.exit(1);
});

